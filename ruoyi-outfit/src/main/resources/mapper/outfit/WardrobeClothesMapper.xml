<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.outfit.mapper.WardrobeClothesMapper">
    
    <resultMap type="WardrobeClothes" id="WardrobeClothesResult">
        <id     property="id"            column="id"              />
        <result property="userId"        column="user_id"         />
        <result property="name"          column="name"            />
        <result property="category"      column="category"        />
        <result property="subCategory"   column="sub_category"    />
        <result property="season"        column="season"          />
        <result property="color"         column="color"           />
        <result property="colorHex"      column="color_hex"       />
        <result property="material"      column="material"        />
        <result property="brand"         column="brand"           />
        <result property="price"         column="price"           />
        <result property="purchaseDate"  column="purchase_date"   />
        <result property="size"          column="size"            />
        <result property="style"         column="style"           />
        <result property="occasion"      column="occasion"        />
        <result property="washMethod"    column="wash_method"     />
        <result property="imageUrl"      column="image_url"       />
        <result property="description"   column="description"     />
        <result property="wearCount"     column="wear_count"      />
        <result property="lastWearDate"  column="last_wear_date"  />
        <result property="isFavorite"    column="is_favorite"     />
        <result property="favoriteCount" column="favorite_count"  />
        <result property="isPublic"      column="is_public"       />
        <result property="status"        column="status"          />
        <result property="delFlag"       column="del_flag"        />
        <result property="createBy"      column="create_by"       />
        <result property="createTime"    column="create_time"     />
        <result property="updateBy"      column="update_by"       />
        <result property="updateTime"    column="update_time"     />
        <result property="remark"        column="remark"          />
        <result property="nickName"      column="nick_name"       />
        <result property="avatar"        column="avatar"          />
    </resultMap>

    <sql id="selectWardrobeClothesVo">
        select c.id, c.user_id, c.name, c.category, c.sub_category, c.season, c.color, c.color_hex, 
               c.material, c.brand, c.price, c.purchase_date, c.size, c.style, c.occasion, c.wash_method, 
               c.image_url, c.description, c.wear_count, c.last_wear_date, c.is_favorite, c.favorite_count,
               c.is_public, c.status, c.del_flag, c.create_by, c.create_time, c.update_by, c.update_time, c.remark,
               u.nick_name, u.avatar
        from wardrobe_clothes c
        left join sys_user u on c.user_id = u.user_id
    </sql>

    <select id="selectWardrobeClothesList" parameterType="WardrobeClothes" resultMap="WardrobeClothesResult">
        <include refid="selectWardrobeClothesVo"/>
        <where>
            c.del_flag = '0'
            <if test="userId != null">
                and c.user_id = #{userId}
            </if>
            <if test="name != null and name != ''">
                and c.name like concat('%', #{name}, '%')
            </if>
            <if test="category != null and category != ''">
                and c.category = #{category}
            </if>
            <if test="subCategory != null and subCategory != ''">
                and c.sub_category = #{subCategory}
            </if>
            <if test="season != null and season != ''">
                and c.season = #{season}
            </if>
            <if test="color != null and color != ''">
                and c.color = #{color}
            </if>
            <if test="material != null and material != ''">
                and c.material = #{material}
            </if>
            <if test="brand != null and brand != ''">
                and c.brand like concat('%', #{brand}, '%')
            </if>
            <if test="style != null and style != ''">
                and c.style = #{style}
            </if>
            <if test="isFavorite != null and isFavorite != ''">
                and c.is_favorite = #{isFavorite}
            </if>
            <if test="isPublic != null and isPublic != ''">
                and c.is_public = #{isPublic}
            </if>
            <if test="status != null and status != ''">
                and c.status = #{status}
            </if>
        </where>
        order by c.create_time desc
    </select>

    <!-- 查询公开的衣物列表（所有用户都可见） -->
    <select id="selectPublicClothesList" parameterType="WardrobeClothes" resultMap="WardrobeClothesResult">
        <include refid="selectWardrobeClothesVo"/>
        <where>
            c.del_flag = '0' and c.is_public = '1'
            <if test="name != null and name != ''">
                and c.name like concat('%', #{name}, '%')
            </if>
            <if test="category != null and category != ''">
                and c.category = #{category}
            </if>
            <if test="subCategory != null and subCategory != ''">
                and c.sub_category = #{subCategory}
            </if>
            <if test="season != null and season != ''">
                and c.season = #{season}
            </if>
            <if test="color != null and color != ''">
                and c.color = #{color}
            </if>
            <if test="material != null and material != ''">
                and c.material = #{material}
            </if>
            <if test="brand != null and brand != ''">
                and c.brand like concat('%', #{brand}, '%')
            </if>
            <if test="style != null and style != ''">
                and c.style = #{style}
            </if>
            <if test="status != null and status != ''">
                and c.status = #{status}
            </if>
        </where>
        order by c.favorite_count desc, c.create_time desc
    </select>

    <!-- 查询用户收藏的衣物列表 -->
    <select id="selectFavoriteClothesList" resultMap="WardrobeClothesResult">
        <include refid="selectWardrobeClothesVo"/>
        inner join wardrobe_clothes_favorite f on c.id = f.clothes_id and f.user_id = #{currentUserId}
        <where>
            c.del_flag = '0'
            <if test="clothes.name != null and clothes.name != ''">
                and c.name like concat('%', #{clothes.name}, '%')
            </if>
            <if test="clothes.category != null and clothes.category != ''">
                and c.category = #{clothes.category}
            </if>
            <if test="clothes.season != null and clothes.season != ''">
                and c.season = #{clothes.season}
            </if>
            <if test="clothes.color != null and clothes.color != ''">
                and c.color = #{clothes.color}
            </if>
            <if test="clothes.style != null and clothes.style != ''">
                and c.style = #{clothes.style}
            </if>
        </where>
        order by f.create_time desc
    </select>
    
    <select id="selectWardrobeClothesById" parameterType="Long" resultMap="WardrobeClothesResult">
        <include refid="selectWardrobeClothesVo"/>
        where c.id = #{id} and c.del_flag = '0'
    </select>
        
    <insert id="insertWardrobeClothes" parameterType="WardrobeClothes" useGeneratedKeys="true" keyProperty="id">
        insert into wardrobe_clothes
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="userId != null">user_id,</if>
            <if test="name != null and name != ''">name,</if>
            <if test="category != null and category != ''">category,</if>
            <if test="subCategory != null">sub_category,</if>
            <if test="season != null">season,</if>
            <if test="color != null">color,</if>
            <if test="colorHex != null">color_hex,</if>
            <if test="material != null">material,</if>
            <if test="brand != null">brand,</if>
            <if test="price != null">price,</if>
            <if test="purchaseDate != null">purchase_date,</if>
            <if test="size != null">size,</if>
            <if test="style != null">style,</if>
            <if test="occasion != null">occasion,</if>
            <if test="washMethod != null">wash_method,</if>
            <if test="imageUrl != null">image_url,</if>
            <if test="description != null">description,</if>
            <if test="wearCount != null">wear_count,</if>
            <if test="lastWearDate != null">last_wear_date,</if>
            <if test="isFavorite != null">is_favorite,</if>
            <if test="status != null">status,</if>
            <if test="delFlag != null">del_flag,</if>
            <if test="createBy != null">create_by,</if>
            <if test="remark != null">remark,</if>
            create_time
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="userId != null">#{userId},</if>
            <if test="name != null and name != ''">#{name},</if>
            <if test="category != null and category != ''">#{category},</if>
            <if test="subCategory != null">#{subCategory},</if>
            <if test="season != null">#{season},</if>
            <if test="color != null">#{color},</if>
            <if test="colorHex != null">#{colorHex},</if>
            <if test="material != null">#{material},</if>
            <if test="brand != null">#{brand},</if>
            <if test="price != null">#{price},</if>
            <if test="purchaseDate != null">#{purchaseDate},</if>
            <if test="size != null">#{size},</if>
            <if test="style != null">#{style},</if>
            <if test="occasion != null">#{occasion},</if>
            <if test="washMethod != null">#{washMethod},</if>
            <if test="imageUrl != null">#{imageUrl},</if>
            <if test="description != null">#{description},</if>
            <if test="wearCount != null">#{wearCount},</if>
            <if test="lastWearDate != null">#{lastWearDate},</if>
            <if test="isFavorite != null">#{isFavorite},</if>
            <if test="status != null">#{status},</if>
            <if test="delFlag != null">#{delFlag},</if>
            <if test="createBy != null">#{createBy},</if>
            <if test="remark != null">#{remark},</if>
            sysdate()
        </trim>
    </insert>

    <update id="updateWardrobeClothes" parameterType="WardrobeClothes">
        update wardrobe_clothes
        <trim prefix="SET" suffixOverrides=",">
            <if test="name != null and name != ''">name = #{name},</if>
            <if test="category != null and category != ''">category = #{category},</if>
            <if test="subCategory != null">sub_category = #{subCategory},</if>
            <if test="season != null">season = #{season},</if>
            <if test="color != null">color = #{color},</if>
            <if test="colorHex != null">color_hex = #{colorHex},</if>
            <if test="material != null">material = #{material},</if>
            <if test="brand != null">brand = #{brand},</if>
            <if test="price != null">price = #{price},</if>
            <if test="purchaseDate != null">purchase_date = #{purchaseDate},</if>
            <if test="size != null">size = #{size},</if>
            <if test="style != null">style = #{style},</if>
            <if test="occasion != null">occasion = #{occasion},</if>
            <if test="washMethod != null">wash_method = #{washMethod},</if>
            <if test="imageUrl != null">image_url = #{imageUrl},</if>
            <if test="description != null">description = #{description},</if>
            <if test="wearCount != null">wear_count = #{wearCount},</if>
            <if test="lastWearDate != null">last_wear_date = #{lastWearDate},</if>
            <if test="isFavorite != null">is_favorite = #{isFavorite},</if>
            <if test="status != null">status = #{status},</if>
            <if test="updateBy != null">update_by = #{updateBy},</if>
            <if test="remark != null">remark = #{remark},</if>
            update_time = sysdate()
        </trim>
        where id = #{id}
    </update>

    <update id="deleteWardrobeClothesById" parameterType="Long">
        update wardrobe_clothes set del_flag = '2' where id = #{id}
    </update>

    <update id="deleteWardrobeClothesByIds" parameterType="String">
        update wardrobe_clothes set del_flag = '2' where id in 
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <update id="updateWearRecord" parameterType="Long">
        update wardrobe_clothes 
        set wear_count = wear_count + 1, last_wear_date = curdate(), update_time = sysdate()
        where id = #{id}
    </update>

    <update id="updateFavorite" parameterType="WardrobeClothes">
        update wardrobe_clothes 
        set is_favorite = #{isFavorite}, update_time = sysdate()
        where id = #{id}
    </update>

    <select id="countByUserId" parameterType="Long" resultType="int">
        select count(*) from wardrobe_clothes where user_id = #{userId} and del_flag = '0'
    </select>

    <select id="countByCategory" parameterType="Long" resultType="java.util.Map">
        select category as name, count(*) as value 
        from wardrobe_clothes 
        where user_id = #{userId} and del_flag = '0'
        group by category
    </select>

    <select id="countBySeason" parameterType="Long" resultType="java.util.Map">
        select season as name, count(*) as value 
        from wardrobe_clothes 
        where user_id = #{userId} and del_flag = '0'
        group by season
    </select>

    <select id="countByColor" parameterType="Long" resultType="java.util.Map">
        select color as name, count(*) as value 
        from wardrobe_clothes 
        where user_id = #{userId} and del_flag = '0'
        group by color
    </select>

    <update id="updateFavoriteCount">
        update wardrobe_clothes set favorite_count = #{favoriteCount}, update_time = NOW() where id = #{id}
    </update>
</mapper>

