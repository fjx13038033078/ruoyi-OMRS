<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.outfit.mapper.WardrobeOutfitMapper">

    <resultMap type="WardrobeOutfit" id="WardrobeOutfitResult">
        <id     property="id"            column="id"              />
        <result property="userId"        column="user_id"         />
        <result property="name"          column="name"            />
        <result property="coverImage"    column="cover_image"     />
        <result property="style"         column="style"           />
        <result property="scene"         column="scene"           />
        <result property="season"        column="season"          />
        <result property="description"   column="description"     />
        <result property="tags"          column="tags"            />
        <result property="isPublic"      column="is_public"       />
        <result property="favoriteCount" column="favorite_count"  />
        <result property="wearCount"     column="wear_count"      />
        <result property="lastWearDate"  column="last_wear_date"  />
        <result property="status"        column="status"          />
        <result property="delFlag"       column="del_flag"        />
        <result property="createBy"      column="create_by"       />
        <result property="createTime"    column="create_time"     />
        <result property="updateBy"      column="update_by"       />
        <result property="updateTime"    column="update_time"     />
        <result property="remark"        column="remark"          />
        <result property="nickName"      column="nick_name"       />
        <result property="avatar"        column="avatar"          />
    </resultMap>

    <sql id="selectWardrobeOutfitVo">
        select o.id, o.user_id, o.name, o.cover_image, o.style, o.scene, o.season, o.description,
               o.tags, o.is_public, o.favorite_count, o.wear_count, o.last_wear_date, o.status,
               o.del_flag, o.create_by, o.create_time, o.update_by, o.update_time, o.remark,
               u.nick_name, u.avatar
        from wardrobe_outfit o
        left join sys_user u on o.user_id = u.user_id
    </sql>

    <select id="selectWardrobeOutfitById" parameterType="Long" resultMap="WardrobeOutfitResult">
        <include refid="selectWardrobeOutfitVo"/>
        where o.id = #{id} and o.del_flag = '0'
    </select>

    <select id="selectWardrobeOutfitList" parameterType="WardrobeOutfit" resultMap="WardrobeOutfitResult">
        <include refid="selectWardrobeOutfitVo"/>
        <where>
            o.del_flag = '0'
            <if test="userId != null">
                and o.user_id = #{userId}
            </if>
            <if test="name != null and name != ''">
                and o.name like concat('%', #{name}, '%')
            </if>
            <if test="style != null and style != ''">
                and o.style = #{style}
            </if>
            <if test="scene != null and scene != ''">
                and o.scene = #{scene}
            </if>
            <if test="season != null and season != ''">
                and o.season = #{season}
            </if>
            <if test="isPublic != null and isPublic != ''">
                and o.is_public = #{isPublic}
            </if>
            <if test="status != null and status != ''">
                and o.status = #{status}
            </if>
        </where>
        order by o.create_time desc
    </select>

    <select id="selectPublicOutfitList" parameterType="WardrobeOutfit" resultMap="WardrobeOutfitResult">
        <include refid="selectWardrobeOutfitVo"/>
        <where>
            o.del_flag = '0' and o.is_public = '1' and o.status = '0'
            <if test="name != null and name != ''">
                and o.name like concat('%', #{name}, '%')
            </if>
            <if test="style != null and style != ''">
                and o.style = #{style}
            </if>
            <if test="scene != null and scene != ''">
                and o.scene = #{scene}
            </if>
            <if test="season != null and season != ''">
                and o.season = #{season}
            </if>
        </where>
        order by o.favorite_count desc, o.create_time desc
    </select>

    <select id="selectFavoriteOutfitList" resultMap="WardrobeOutfitResult">
        <include refid="selectWardrobeOutfitVo"/>
        inner join wardrobe_outfit_favorite f on o.id = f.outfit_id and f.user_id = #{currentUserId}
        <where>
            o.del_flag = '0'
            <if test="outfit.name != null and outfit.name != ''">
                and o.name like concat('%', #{outfit.name}, '%')
            </if>
            <if test="outfit.style != null and outfit.style != ''">
                and o.style = #{outfit.style}
            </if>
            <if test="outfit.scene != null and outfit.scene != ''">
                and o.scene = #{outfit.scene}
            </if>
            <if test="outfit.season != null and outfit.season != ''">
                and o.season = #{outfit.season}
            </if>
        </where>
        order by f.create_time desc
    </select>

    <insert id="insertWardrobeOutfit" parameterType="WardrobeOutfit" useGeneratedKeys="true" keyProperty="id">
        insert into wardrobe_outfit
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="userId != null">user_id,</if>
            <if test="name != null and name != ''">name,</if>
            <if test="coverImage != null">cover_image,</if>
            <if test="style != null">style,</if>
            <if test="scene != null">scene,</if>
            <if test="season != null">season,</if>
            <if test="description != null">description,</if>
            <if test="tags != null">tags,</if>
            <if test="isPublic != null">is_public,</if>
            <if test="favoriteCount != null">favorite_count,</if>
            <if test="wearCount != null">wear_count,</if>
            <if test="status != null">status,</if>
            <if test="createBy != null">create_by,</if>
            <if test="remark != null">remark,</if>
            create_time
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="userId != null">#{userId},</if>
            <if test="name != null and name != ''">#{name},</if>
            <if test="coverImage != null">#{coverImage},</if>
            <if test="style != null">#{style},</if>
            <if test="scene != null">#{scene},</if>
            <if test="season != null">#{season},</if>
            <if test="description != null">#{description},</if>
            <if test="tags != null">#{tags},</if>
            <if test="isPublic != null">#{isPublic},</if>
            <if test="favoriteCount != null">#{favoriteCount},</if>
            <if test="wearCount != null">#{wearCount},</if>
            <if test="status != null">#{status},</if>
            <if test="createBy != null">#{createBy},</if>
            <if test="remark != null">#{remark},</if>
            NOW()
        </trim>
    </insert>

    <update id="updateWardrobeOutfit" parameterType="WardrobeOutfit">
        update wardrobe_outfit
        <trim prefix="SET" suffixOverrides=",">
            <if test="name != null and name != ''">name = #{name},</if>
            <if test="coverImage != null">cover_image = #{coverImage},</if>
            <if test="style != null">style = #{style},</if>
            <if test="scene != null">scene = #{scene},</if>
            <if test="season != null">season = #{season},</if>
            <if test="description != null">description = #{description},</if>
            <if test="tags != null">tags = #{tags},</if>
            <if test="isPublic != null">is_public = #{isPublic},</if>
            <if test="wearCount != null">wear_count = #{wearCount},</if>
            <if test="lastWearDate != null">last_wear_date = #{lastWearDate},</if>
            <if test="status != null">status = #{status},</if>
            <if test="updateBy != null">update_by = #{updateBy},</if>
            <if test="remark != null">remark = #{remark},</if>
            update_time = NOW()
        </trim>
        where id = #{id}
    </update>

    <update id="deleteWardrobeOutfitById" parameterType="Long">
        update wardrobe_outfit set del_flag = '2' where id = #{id}
    </update>

    <update id="deleteWardrobeOutfitByIds" parameterType="String">
        update wardrobe_outfit set del_flag = '2' where id in
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <update id="updateFavoriteCount">
        update wardrobe_outfit set favorite_count = #{favoriteCount}, update_time = NOW() where id = #{id}
    </update>

    <update id="updateWearRecord" parameterType="Long">
        update wardrobe_outfit
        set wear_count = wear_count + 1, last_wear_date = CURDATE(), update_time = NOW()
        where id = #{id}
    </update>

</mapper>
